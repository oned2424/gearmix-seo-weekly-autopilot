name: GMX Weekly SEO Report Generator

on:
  # æ¯é€±æœˆæ›œæ—¥ 00:00 UTC (09:00 JST) ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 0 * * 1'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  generate-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ” èªè¨¼æƒ…å ±ã‚’è¨­å®š
        env:
          GMX_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GMX_SERVICE_ACCOUNT_CREDENTIALS }}
          GMX_GA4_PROPERTY_ID: ${{ secrets.GMX_GA4_PROPERTY_ID }}
        run: |
          echo "èªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ"
      
      - name: ğŸ“Š é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        env:
          GMX_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GMX_SERVICE_ACCOUNT_CREDENTIALS }}
          GMX_GA4_PROPERTY_ID: ${{ secrets.GMX_GA4_PROPERTY_ID }}
          # Google Drive
          GMX_DRIVE_CREDENTIALS: ${{ secrets.GMX_DRIVE_CREDENTIALS }}
          GMX_DRIVE_FOLDER_ID: ${{ secrets.GMX_DRIVE_FOLDER_ID }}
        run: |
          python gmx_weekly_report.py
      
      - name: ğŸ“¤ ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "seo-bot@gearmix.co.jp"
          git config --local user.name "GearMix SEO Bot"
          git add reports/
          
          # å¤‰æ›´ãƒã‚§ãƒƒã‚¯
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          
          git commit -m "ğŸ“Š é€±æ¬¡SEOãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ - $(date +'%Y-%m-%d')"
          
          # ç«¶åˆå›é¿ãƒªãƒˆãƒ©ã‚¤ãƒ«ãƒ¼ãƒ—
          MAX_RETRIES=5
          count=0
          success=false
          
          while [ $count -lt $MAX_RETRIES ]; do
            echo "Attempting to push (Try $((count+1))/$MAX_RETRIES)..."
            
            # æœ€æ–°ã‚’å–ã‚Šè¾¼ã‚€
            git pull --rebase origin main
            
            # ãƒ—ãƒƒã‚·ãƒ¥è©¦è¡Œ
            if git push origin main; then
              success=true
              echo "âœ… Successfully pushed changes."
              break
            else
              echo "âš ï¸ Push failed. Waiting to retry..."
              count=$((count+1))
              sleep 5
            fi
          done
          
          if [ "$success" = false ]; then
            echo "âŒ Failed to push after $MAX_RETRIES attempts."
            exit 1
          fi
